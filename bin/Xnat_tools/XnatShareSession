#!/usr/bin/env python
# -*- coding: utf-8 -*-

'''
Switch sessions from one project to another using CSV from Xnatdownload

Created on April 13th, 2023

@author: William Duett, VUIIS CCI, Vanderbilt University
'''

# Libraries
import re
import os
import shutil
import pyxnat
import time
import logging
import os
import sys


def check_project(project):
    print('Checking project exists on XNAT')
    if not project.exists():
        raise Exception('Project ' + str(project).split('> ')[1] + ' NOT found in XNAT')
    else:
        print(str(project).split('> ')[1].split(' ')[0] + ' found!')


def share_subj(subj,subj_str,rec_proj_str):
    if subj.exists():
        try:
            print('Sharing subject: ' + subj_str)
            subj.insert(**{
                'subjects':'xnat:subjectData',
                'xnat:subjectData/sharing/share/project':rec_proj_str,
                'xnat:subjectData/sharing/share/label':subj_str
                })
            print('Subject Created!')
        except:
            raise Exception('Subject exists, but encountered an error')
    else:
        print('Subject already exists: ' + subj_str)


def share_exp(exp,exp_str,rec_proj_str):
    if exp.exists():
        try:
            print('Sharing Experiment: ' + exp_str)
            exp.insert(**{
                'experiments':'xnat:hdSessionData',
                'xnat:hdSessionData/sharing/share/project':rec_proj_str,
                'xnat:hdSessionData/sharing/share/label':exp_str
                })
            print('Experiment Created!')
        except:
            raise Exception('Experiment exists, but encountered an error')
    else:
        print('Experiment already exists: ' + exp_str)


if __name__ == '__main__':
    try:
        XNAT = pyxnat.Interface(server="https://xnat.vanderbilt.edu/xnat",
                                user=os.getlogin())
    except:
        raise Exception('Unable to connect to XNAT')

    send_proj = XNAT.select.project('VUSTP')
    rec_proj = XNAT.select.project('VUIIS_ABCD')
    subj = send_proj.subject('212533')
    exp = subj.experiment('212533')

    check_project(send_proj)
    check_project(rec_proj)

    send_proj_str = str(send_proj).split('> ')[1].split(' ')[0]
    rec_proj_str = str(rec_proj). split('> ')[1].split(' ')[0]
    subj_str = str(subj).split('> ')[1].split(' ')[0]
    exp_str = str(exp).split('> ')[1]

    share_subj(subj,subj_str,rec_proj_str)
#    share_exp(exp,exp_str,rec_proj_str)

    XNAT.disconnect()
